import gradio as gr
import os
from datetime import datetime, timedelta

# =========================
# DATA
# =========================
SERVICE_DATES = [
    "2025-01-10","2025-02-10","2025-03-10","2025-04-10","2025-05-13",
    "2025-06-10","2025-07-14","2025-08-11","2025-09-11","2025-10-10",
    "2025-11-10","2025-12-11","2026-01-12","2026-02-10","2026-03-10",
    "2026-04-10","2026-05-11","2026-06-11","2026-07-10","2026-08-10",
    "2026-09-10","2026-10-12","2026-11-10","2026-12-11","2027-01-12",
    "2027-02-11","2027-03-11","2027-04-09","2027-05-11","2027-06-10",
    "2027-07-13","2027-08-10","2027-09-10","2027-10-12","2027-11-11",
    "2027-12-14"
]

SERVICE_DATES = [datetime.strptime(d, "%Y-%m-%d") for d in SERVICE_DATES]

VACCINE_SCHEDULE = [
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1: ‡πÅ‡∏£‡∏Å‡πÄ‡∏Å‡∏¥‡∏î", 0, "BCG, HB1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2: 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 60, "IPV1, DTP-HB-HIB1, ROTARIX1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3: 4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 120, "IPV2, DTP-HB-HIB2, ROTARIX2"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 4: 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 180, "OPV1, DTP-HB-HIB3"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 5: 9 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 270, "MMR1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 6: 1 ‡∏õ‡∏µ", 365, "LAJE1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 7: 1 ‡∏õ‡∏µ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 365+180, "OPV2, MMR2, DTP4"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 8: 2 ‡∏õ‡∏µ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 365*2+180, "LAJE2"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 9: 4 ‡∏õ‡∏µ", 365*4, "OPV3, DTP5"),
]

# =========================
# LOGIC
# =========================
def calculate_vaccine_schedule(birth_date_str):
    try:
        birth_date = datetime.strptime(birth_date_str, "%d-%m-%Y")
    except:
        return "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö **DD-MM-YYYY**"

    md = "## üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏î‡πá‡∏Å\n\n"
    md += f"**‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏î‡πá‡∏Å:** {birth_date.strftime('%d %B %Y')}\n\n"
    md += "| ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà | ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô | ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î | ‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á |\n"
    md += "|---|---|---|---|\n"

    for i, (round_name, offset_days, vaccines) in enumerate(VACCINE_SCHEDULE):
        due_date = birth_date + timedelta(days=offset_days)

        # ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1: ‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ï‡∏£‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)
        if i == 0:
            service_date = due_date
        else:
            service_date = next_service_date(due_date)

        md += (
            f"| {round_name} | {vaccines} | "
            f"{due_date.strftime('%d %B %Y')} | "
            f"{service_date.strftime('%d %B %Y') if service_date else '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'} |\n"
        )

    return md


# =========================
# GRADIO APP
# =========================
app = gr.Interface(
    fn=calculate_vaccine_schedule,
    inputs=gr.Textbox(
        label="‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏î‡πá‡∏Å (DD-MM-YYYY)",
        placeholder="15-01-2025"
    ),
    outputs=gr.Markdown(),
    title="üßí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏î‡πá‡∏Å (‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏£‡∏û‡∏™‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà)",
    description="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏î‡πá‡∏Å ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)"
)

# =========================
# CLOUD RUN ENTRYPOINT
# =========================
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    app.launch(
        server_name="0.0.0.0",
        server_port=port,
        show_error=True
    )
