import gradio as gr
import os
from datetime import datetime, timedelta
from fastapi import FastAPI
import uvicorn

# =========================
# DATA
# =========================
SERVICE_DATES = [
    "2568-01-10","2568-02-10","2568-03-10","2568-04-10","2568-05-13",
    "2568-06-10","2568-07-14","2568-08-11","2568-09-11","2568-10-10",
    "2568-11-10","2568-12-11","2569-01-12","2569-02-10","2569-03-10",
    "2569-04-10","2569-05-11","2569-06-11","2569-07-10","2569-08-10",
    "2569-09-10","2569-10-12","2569-11-10","2569-12-11","2570-01-12",
    "2570-02-11","2570-03-11","2570-04-09","2570-05-11","2570-06-10",
    "2570-07-13","2570-08-10","2570-09-10","2570-10-12","2570-11-11",
    "2570-12-14","2571-01-10","2571-02-11","2571-03-10","2571-04-10",
    "2571-05-11","2571-06-12","2571-07-10","2571-08-10","2571-09-11",
    "2571-10-10","2571-11-10","2571-12-12"
]

SERVICE_DATES = [datetime.strptime(d, "%Y-%m-%d") for d in SERVICE_DATES]

VACCINE_SCHEDULE = [
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1: ‡πÅ‡∏£‡∏Å‡πÄ‡∏Å‡∏¥‡∏î", 0, "BCG, HB1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2: 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 60, "IPV1, DTP-HB-HIB1, ROTARIX1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3: 4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 120, "IPV2, DTP-HB-HIB2, ROTARIX2"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 4: 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 180, "OPV1, DTP-HB-HIB3"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 5: 9 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 270, "MMR1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 6: 1 ‡∏õ‡∏µ", 365, "LAJE1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 7: 1 ‡∏õ‡∏µ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 545, "OPV2, MMR2, DTP4"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 8: 2 ‡∏õ‡∏µ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 910, "LAJE2"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 9: 4 ‡∏õ‡∏µ", 1460, "OPV3, DTP5"),
]

# =========================
# THAI DATE FORMAT
# =========================
THAI_MONTHS = [
    "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
    "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
]

def format_thai_date(dt):
    return f"{dt.day} {THAI_MONTHS[dt.month - 1]} {dt.year}"

# =========================
# LOGIC
# =========================
def next_service_date(target_date):
    for d in SERVICE_DATES:
        if d >= target_date:
            return d
    return None

def calculate_vaccine_schedule(birth_date_str):
    try:
        birth_date = datetime.strptime(birth_date_str, "%d-%m-%Y")
    except:
        return "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö **DD-MM-YYYY**"

    md = "## üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏î‡πá‡∏Å\n\n"
    md += f"**‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏î‡πá‡∏Å:** {format_thai_date(birth_date)}\n\n"
    md += "| ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà | ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô | ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏û.‡∏®.) | ‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á (‡∏û.‡∏®.) |\n"
    md += "|---|---|---|---|\n"

    for i, (round_name, offset_days, vaccines) in enumerate(VACCINE_SCHEDULE):
        due_date = birth_date + timedelta(days=offset_days)
        service_date = due_date if i == 0 else next_service_date(due_date)

        md += (
            f"| {round_name} | {vaccines} | "
            f"{format_thai_date(due_date)} | "
            f"{format_thai_date(service_date) if service_date else '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'} |\n"
        )

    return md

# =========================
# GRADIO INTERFACE
# =========================
gradio_app = gr.Interface(
    fn=calculate_vaccine_schedule,
    inputs=gr.Textbox(label="‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏î‡πá‡∏Å (DD-MM-YYYY)"),
    outputs=gr.Markdown(),
    title="üßí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏î‡πá‡∏Å",
    description="""
<p align="center">
  #<img src="/file=logo.png" width="180"><br>
  <b>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏£‡∏û‡∏™‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏õ‡∏≤‡∏Å‡πÄ‡∏Å‡∏£‡πá‡∏î</b><br>
  ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢ ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‡∏°‡∏™‡∏ò.
</p>
"""

# =========================
# FASTAPI + CLOUD RUN
# =========================
app = FastAPI()
app = gr.mount_gradio_app(app, gradio_app, path="/")

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    uvicorn.run(app, host="0.0.0.0", port=port)
