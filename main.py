import gradio as gr
import os
from datetime import datetime, timedelta

# =========================
# DATA
# =========================
SERVICE_DATES = [
    "2025-01-10","2025-02-10","2025-03-10","2025-04-10","2025-05-13",
    "2025-06-10","2025-07-14","2025-08-11","2025-09-11","2025-10-10",
    "2025-11-10","2025-12-11","2026-01-12","2026-02-10","2026-03-10",
    "2026-04-10","2026-05-11","2026-06-11","2026-07-10","2026-08-10",
    "2026-09-10","2026-10-12","2026-11-10","2026-12-11","2027-01-12",
    "2027-02-11","2027-03-11","2027-04-09","2027-05-11","2027-06-10",
    "2027-07-13","2027-08-10","2027-09-10","2027-10-12","2027-11-11",
    "2027-12-14","2028-01-10","2028-02-11","2028-03-10","2028-04-10",
    "2028-05-11","2028-06-12","2028-06-12","2028-07-10","2028-08-10",
    "2028-09-11","2028-10-10","2028-11-10","2028-12-12"
]

SERVICE_DATES = [datetime.strptime(d, "%Y-%m-%d") for d in SERVICE_DATES]

VACCINE_SCHEDULE = [
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1: ‡πÅ‡∏£‡∏Å‡πÄ‡∏Å‡∏¥‡∏î", 0, "BCG, HB1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2: 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 60, "IPV1, DTP-HB-HIB1, ROTARIX1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3: 4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 120, "IPV2, DTP-HB-HIB2, ROTARIX2"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 4: 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 180, "OPV1, DTP-HB-HIB3"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 5: 9 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 270, "MMR1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 6: 1 ‡∏õ‡∏µ", 365, "LAJE1"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 7: 1 ‡∏õ‡∏µ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 545, "OPV2, MMR2, DTP4"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 8: 2 ‡∏õ‡∏µ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 910, "LAJE2"),
    ("‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 9: 4 ‡∏õ‡∏µ", 1460, "OPV3, DTP5"),
]

def next_service_date(target_date):
    for d in SERVICE_DATES:
        if d >= target_date:
            return d
    return None

def calculate_vaccine_schedule(birth_date_str):
    try:
        birth_date = datetime.strptime(birth_date_str, "%d-%m-%Y")
    except:
        return "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö **DD-MM-YYYY**"

    md = "## üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏î‡πá‡∏Å\n\n"
    md += f"**‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏î‡πá‡∏Å:** {birth_date.strftime('%d %B %Y')}\n\n"
    md += "| ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà | ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô | ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î | ‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á |\n"
    md += "|---|---|---|---|\n"

    for i, (round_name, offset_days, vaccines) in enumerate(VACCINE_SCHEDULE):
        due_date = birth_date + timedelta(days=offset_days)
        service_date = due_date if i == 0 else next_service_date(due_date)

        md += (
            f"| {round_name} | {vaccines} | "
            f"{due_date.strftime('%d %B %Y')} | "
            f"{service_date.strftime('%d %B %Y') if service_date else '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'} |\n"
        )

    return md

app = gr.Interface(
    fn=calculate_vaccine_schedule,
    inputs=gr.Textbox(label="‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏î‡πá‡∏Å (DD-MM-YYYY)", placeholder="15-01-2025"),
    outputs=gr.Markdown(),
    title="üßí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏î‡πá‡∏Å",
    description=
    "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á"
    "‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢ ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‡∏°‡∏™‡∏ò. ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 1/2568"
)

# =========================
# CLOUD RUN ENTRYPOINT
# =========================
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    app.launch(
        server_name="0.0.0.0",
        server_port=port
    )
